#!/bin/bash
# mindevenviro-windows search
# I use dos2unix to convert file endings
###	WARNING: DON'T EDIT ANYTHING BELOW ###
#set -x
LANG="C";
IFS="$(echo -en "\n\b")" ;
line='';
pause="0";
path=''
exclud3=''
togrep=''
exclud3=''
			if [[ "$EUID" != "0" ]] ;
		then
	echo -e "sudo search -h :: please\n" ;
	help_function ;
else

# temp folder
		if [[ "$(df -h | grep -E shm$ | cut -f2 -d% | tr -d '\ ')" != '' ]] ;
	then
		tmpfolder="$(df -h | grep -E shm$ | cut -f2 -d% | tr -d '\ ')" ;
	else
		tmpfolder="/tmp" ;
fi
# temp folder END

touch $tmpfolder/line.search ;

help_function(){
echo -e "\nUsage: sudo search [-s|--search] [PATH] [TOSEARCH] [TOGREP] [TOEXCLUDE]\n
SEARCH THE DRIVE\n
 This script searches your drive\r
 for everything in it, and displays on the Terminal.\r
 Finds: log files, example code, .conf to edit...\n
 [PATH]: the absolute path like: /var/
 [TOSEARCH]: search pattern\r
 [TOGREP]: search a word in file\r
 [TOEXCLUDE]: a word you want to exclude from your search results.\n" ;
exit 0 ;
}

searchStat(){
#echo "searchStat function"
	echo -e "search $(date) :: as $SUDO_USER :: in $(uname -n) :: $path $exclud3 $togrep $exclud3 ::" >>"/home/$SUDO_USER/.wH0rUNSon" && wait ;
}

#exithandler
exitHandl3R(){
#echo "exitHandl3R function"
	searchStat;
	pgrep less | awk "{print $1}" | xargs kill -15 2>/dev/null ; 
	pgrep nano | awk "{print $1}" | xargs kill -15 2>/dev/null ; 
	pgrep mupdf | awk "{print $1}" | xargs kill -15 2>/dev/null ;
	echo -e "\n ... good bye $SUDO_USER" ;
	exit 0 ;
}

display(){
#echo "display function"
# display	
			# uS3F is the owner of the file
			uS3F=$(ls -sl "$filename" | awk '{print $4}' | tr -d '\ ');
###
			if [[ $(echo "$filename" | xargs basename | sed 's/\./\ /g' | awk '{print $2}') =~ conf|ini|config ]] ;
		then
				pause="1" ;
				sudo -u "$uS3F" nano "$filename" && return ;

				if [[ ! $(echo "$filename" | xargs file) =~ PDF|PHP|script|ASCII|text|TEXT|HTML|XML ]] ;
			then
				pause="1" ;
				echo -e " ... no PDF|PHP|script|ASCII|text|TEXT|HTML|XML \r" ;
			else
				pause="1" ;
				echo -e " ... $(echo $filename | xargs file) :: - nothing to show\r" ;
		fi
###
			if [[ ! $(echo "$filename" | xargs basename | sed 's/\./\ /g' | awk '{print $2}') =~ conf|ini|config ]] ;
		then
			pause="1" ;
			sudo -u "$uS3F" less "$line" && return ;
		else
			if [[ $(dpkg -l | grep mupdf | awk '{print $2}') != '' ]] && [[ $(echo "$filename" | xargs file) =~ PDF ]] ;
		then
			pause="1" ;
			sudo -u "$uS3F" mupdf "$filename" && return ;
		else
			pause="1" ;
			echo -e " ... no PDF viewer installed, or you are in Windows \r" ;
			echo -e " ... $(echo $filename | xargs file) :: - nothing to show\r" ;
		fi
	fi
				else
					return ;
fi
###
#display END
}

# search query 1
eingabe1(){
#echo "eingabe function 2"

		while read line
	do
		if [ $pause = 1 ] ;
	then
		if [[ "$togrep" != '' ]] && [[ "$exclud3" = '' ]] ;
	then
		filename=$line;
		cat $line | grep -E $togrep >| "$tmpfolder/line.search" ;
		echo $filename >> "$tmpfolder/line.search" ;
		line="$tmpfolder/line.search" ;
		printf " ... continue ... " ; read -p -r ;
		wait ;
		display ;

		elif [[ "$exclud3" != '' ]] && [[ "$togrep" != '' ]] ;
	then
		filename=$line;
		cat $line | grep -E $togrep | grep -vE $exclud3 >| "$tmpfolder/line.search" ;
		echo $filename >> "$tmpfolder/line.search" ;
		line="$tmpfolder/line.search" ;
		printf " ... continue ... " ; read -p -r ;
		wait ;
		display ;
	fi
fi
done<<<"$line";
}

# search query 2
eingabe2(){
#echo "eingabe function 2"

		while read line
	do
		if [ $pause = 0 ] ;
	then
		if [[ "$togrep" != '' ]] && [[ "$exclud3" = '' ]] ;
	then
		filename=$line;
		cat $line | grep -E $togrep >| "$tmpfolder/line.search" ;
		echo $filename >> "$tmpfolder/line.search" ;
		line="$tmpfolder/line.search" ;
		display ;

		elif [[ "$exclud3" != '' ]] && [[ "$togrep" != '' ]] ;
	then
		filename=$line;
		cat $line | grep -E $togrep | grep -vE $exclud3 >| "$tmpfolder/line.search" ;
		echo $filename >> "$tmpfolder/line.search" ;
		line="$tmpfolder/line.search" ;
		display ;
	fi
fi
done<<<"$line";
}
# search query		END#

# Main function
main(){
#echo "main function"
searchP4th="$2";
searchP4ttern="$3";
togrep="$4";
exclud3="$5";
					trap 'exitHandl3R' SIGINT ;

			if  [[ "$exclud3" != '' ]] || [[ "$togrep" != '' ]] ;
		then
				while read line
			do
				if [ $pause = 1 ] ;
			then
				printf " ... to continue: " ; read -r ;
				eingabe1 ;
			fi
			
				if [ $pause = 0 ] ;
			then
				printf " ... to continue: " ; read -r ;
				eingabe2 ;
			fi
			done<<<"$(find "$searchP4th" -name "*$searchP4ttern*" -type f)" ;
	else
			help_function ;
fi
}

# ASK
  case "$1" in
		-s|--search)
        toshiffta=0 ;
        shift "$toshiffta" ;		
		main "$@" ;
        ;;
        -h|--help)
        toshiffta=0 ;
        shift "$toshiffta" ;
		help_function "$@" ;
        ;;
esac
# ASK END
fi

#readonly empty=" empty" ;
#[[ $(echo $tmpfolder/line.search | xargs file | cut -f2 -d:) = $empty ]] ||
